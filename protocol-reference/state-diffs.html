<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>State Diffs - Alloverse Documentation</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>State Diffs | Alloverse Documentation</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="State Diffs" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Getting started with Alloverse. Guides, code snippets, API references…" /> <meta property="og:description" content="Getting started with Alloverse. Guides, code snippets, API references…" /> <link rel="canonical" href="/protocol-reference/state-diffs" /> <meta property="og:url" content="/protocol-reference/state-diffs" /> <meta property="og:site_name" content="Alloverse Documentation" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="State Diffs" /> <script type="application/ld+json"> {"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://alloverse.com/wp-content/uploads/Alloverse-logo-moniker-256x38-1.svg"}},"description":"Getting started with Alloverse. Guides, code snippets, API references…","headline":"State Diffs","url":"/protocol-reference/state-diffs","@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <script type="text/javascript" src="/assets/js/custom.js"></script> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Get Started (Lua)</a></li><li class="nav-list-item"><a href="/csharp" class="nav-list-link">Get Started (C#)</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/classes/" class="nav-list-link">AlloUI lua</a><ul class="nav-list "><li class="nav-list-item "><a href="/doc/classes/App.html" class="nav-list-link">App</a></li><li class="nav-list-item "><a href="/doc/classes/Asset.html" class="nav-list-link">Asset</a></li><li class="nav-list-item "><a href="/doc/classes/AssetManager.html" class="nav-list-link">AssetManager</a></li><li class="nav-list-item "><a href="/doc/classes/AssetView.html" class="nav-list-link">AssetView</a></li><li class="nav-list-item "><a href="/doc/classes/Base64Asset.html" class="nav-list-link">Base64Asset</a></li><li class="nav-list-item "><a href="/doc/classes/Bounds.html" class="nav-list-link">Bounds</a></li><li class="nav-list-item "><a href="/doc/classes/Button.html" class="nav-list-link">Button</a></li><li class="nav-list-item "><a href="/doc/classes/Client.html" class="nav-list-link">Client</a></li><li class="nav-list-item "><a href="/doc/classes/Color.html" class="nav-list-link">Color</a></li><li class="nav-list-item "><a href="/doc/classes/Cube.html" class="nav-list-link">Cube</a></li><li class="nav-list-item "><a href="/doc/classes/Entity.html" class="nav-list-link">Entity</a></li><li class="nav-list-item "><a href="/doc/classes/FileAsset.html" class="nav-list-link">FileAsset</a></li><li class="nav-list-item "><a href="/doc/classes/FrameView.html" class="nav-list-link">FrameView</a></li><li class="nav-list-item "><a href="/doc/classes/GrabHandle.html" class="nav-list-link">GrabHandle</a></li><li class="nav-list-item "><a href="/doc/classes/Label.html" class="nav-list-link">Label</a></li><li class="nav-list-item "><a href="/doc/classes/LovrFileAsset.html" class="nav-list-link">LovrFileAsset</a></li><li class="nav-list-item "><a href="/doc/classes/ModelView.html" class="nav-list-link">ModelView</a></li><li class="nav-list-item "><a href="/doc/classes/NavStack.html" class="nav-list-link">NavStack</a></li><li class="nav-list-item "><a href="/doc/classes/Ninepatch.html" class="nav-list-link">Ninepatch</a></li><li class="nav-list-item "><a href="/doc/classes/Pose.html" class="nav-list-link">Pose</a></li><li class="nav-list-item "><a href="/doc/classes/PropertyAnimation.html" class="nav-list-link">PropertyAnimation</a></li><li class="nav-list-item "><a href="/doc/classes/ProxyIconView.html" class="nav-list-link">ProxyIconView</a></li><li class="nav-list-item "><a href="/doc/classes/ResizeHandle.html" class="nav-list-link">ResizeHandle</a></li><li class="nav-list-item "><a href="/doc/classes/Size.html" class="nav-list-link">Size</a></li><li class="nav-list-item "><a href="/doc/classes/Slider.html" class="nav-list-link">Slider</a></li><li class="nav-list-item "><a href="/doc/classes/Speaker.html" class="nav-list-link">Speaker</a></li><li class="nav-list-item "><a href="/doc/classes/StackView.html" class="nav-list-link">StackView</a></li><li class="nav-list-item "><a href="/doc/classes/Surface.html" class="nav-list-link">Surface</a></li><li class="nav-list-item "><a href="/doc/classes/TabView.html" class="nav-list-link">TabView</a></li><li class="nav-list-item "><a href="/doc/classes/TextField.html" class="nav-list-link">TextField</a></li><li class="nav-list-item "><a href="/doc/classes/VideoSurface.html" class="nav-list-link">VideoSurface</a></li><li class="nav-list-item "><a href="/doc/classes/View.html" class="nav-list-link">View</a></li></ul></li><li class="nav-list-item"><a href="/concepts/architecture" class="nav-list-link">Architecture</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/protocol-reference" class="nav-list-link">Protocol Reference</a><ul class="nav-list "><li class="nav-list-item "><a href="/protocol-reference/asset-protocols" class="nav-list-link">Asset Protocol</a></li><li class="nav-list-item "><a href="/protocol-reference/coordinate-system" class="nav-list-link">Coordinate System</a></li><li class="nav-list-item "><a href="/protocol-reference/identity" class="nav-list-link">Identity</a></li><li class="nav-list-item "><a href="/protocol-reference/intent" class="nav-list-link">Intent</a></li><li class="nav-list-item "><a href="/protocol-reference/interactions" class="nav-list-link">Interactions</a></li><li class="nav-list-item active"><a href="/protocol-reference/state-diffs" class="nav-list-link active">State Diffs</a></li><li class="nav-list-item "><a href="/protocol-reference/url-definitions" class="nav-list-link">URL Definitions</a></li><li class="nav-list-item "><a href="/protocol-reference/wire-protocol" class="nav-list-link">Wire Protocol</a></li></ul></li><li class="nav-list-item"><a href="/components" class="nav-list-link">Components</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/community" class="nav-list-link">Community</a><ul class="nav-list "><li class="nav-list-item "><a href="/community/contributing" class="nav-list-link">Contributing to Alloverse</a></li><li class="nav-list-item "><a href="/community/code-of-conduct.html" class="nav-list-link">Code of Conduct</a></li></ul></li><li class="nav-list-item"><a href="/hig" class="nav-list-link">3D Interface Design Guidelines</a></li><li class="nav-list-item"><a href="/hosting" class="nav-list-link">Hosting an Alloverse app</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/licenses" class="nav-list-link">Licenses</a><ul class="nav-list "><li class="nav-list-item "><a href="/license/alloverse-license.html" class="nav-list-link">Alloverse License</a></li><li class="nav-list-item "><a href="/licenses/licenses" class="nav-list-link">Licenses used by Alloverse</a></li></ul></li><li class="nav-list-item"><a href="/doc/" class="nav-list-link">Index</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Alloverse Documentation" aria-label="Search Alloverse Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/protocol-reference">Protocol Reference</a></li> <li class="breadcrumb-nav-list-item"><span>State Diffs</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="state-diffs"> <a href="#state-diffs" class="anchor-heading" aria-labelledby="state-diffs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> State Diffs </h1> <p>Every server heart-beat, the server sends the world state to all connected agents on unreliable channel 0.</p> <h2 id="state-representation"> <a href="#state-representation" class="anchor-heading" aria-labelledby="state-representation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> State representation </h2> <p>The world representation is stored as a big JSON document like so:</p> <div class="language-json-doc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"entities"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"abc123"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"components"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">...</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"revision"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">entities</code>: A dictionary from entity ID to <a href="/protocol-reference/#entity">entity description</a>.</li> <li><code class="language-plaintext highlighter-rouge">revision</code>: An integer ID for this specific revision of the world. Monotonically increases until it reaches the biggest sequential integer that a 64-bit IEEE double can represent, which is 2^53, whereafter it will wrap around back to 0. (damn JSON).</li> </ul> <h2 id="deltas"> <a href="#deltas" class="anchor-heading" aria-labelledby="deltas"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deltas </h2> <p>Sending this document in its entirety every server heart-beat would be needlessly wasteful, so instead only the difference to a previous known-good state is sent. An agent acknowledges successful receival of world state by setting <code class="language-plaintext highlighter-rouge">ack_state_rev</code> in <a href="intent"><code class="language-plaintext highlighter-rouge">intent</code></a> to the received world state, whereafter the server will diff against that revision instead. Note that it takes time for this ACK to be received, so you might continue to receive diffs against an older version; so you need to keep a history of previous states to apply diffs to.</p> <p>The packet on channel 0 received in the client can take three forms:</p> <h3 id="format-1-set"> <a href="#format-1-set" class="anchor-heading" aria-labelledby="format-1-set"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Format 1: <code class="language-plaintext highlighter-rouge">set</code> </h3> <p>If the server is unable to diff, it will just send the full world state document.</p> <div class="language-json-doc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"patch_style"</span><span class="p">:</span><span class="w"> </span><span class="s2">"set"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"entities"</span><span class="p">:</span><span class="w"> </span><span class="c1">...</span><span class="p">,</span><span class="w">
  </span><span class="nl">"revision"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Note that <code class="language-plaintext highlighter-rouge">patch_style</code> is not part of the document, and should be removed before the document is stored to history.</p> <h3 id="format-2-apply"> <a href="#format-2-apply" class="anchor-heading" aria-labelledby="format-2-apply"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Format 2: <code class="language-plaintext highlighter-rouge">apply</code> </h3> <p>Indicates that the payload is an <a href="https://tools.ietf.org/html/rfc6902">RFC 6902</a> JSON Patch.</p> <div class="language-json-doc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"patch_style"</span><span class="p">:</span><span class="w"> </span><span class="s2">"apply"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"patch_from"</span><span class="p">:</span><span class="w"> </span><span class="mi">1233</span><span class="p">,</span><span class="w">
  </span><span class="nl">"patches"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="c1">...</span><span class="w"> </span><span class="c">/*RFC 6902 patches*/</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">patch_from</code> indicates the revision to apply the patches to</li> <li><code class="language-plaintext highlighter-rouge">patches</code> is a JSON list of RFC 6902 patches to apply to said revision from history</li> </ul> <p>The patches should be applied and the resulting document stored to history. If the referenced <code class="language-plaintext highlighter-rouge">from</code> revision is not available or history, or if patching fails, you should set intent’s <code class="language-plaintext highlighter-rouge">ack_state_rev</code> back to 0 to request a full <code class="language-plaintext highlighter-rouge">set</code> state.</p> <p><strong>Note</strong>: This format seems to almost always be less efficient than RFC 7386, so its support is likely to be removed.</p> <h3 id="format-3-merge"> <a href="#format-3-merge" class="anchor-heading" aria-labelledby="format-3-merge"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Format 3: <code class="language-plaintext highlighter-rouge">merge</code> </h3> <p>Indicates that the payload is an <a href="https://tools.ietf.org/html/rfc7396">RFC 7386</a> JSON Merge Patch.</p> <div class="language-json-doc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"patch_style"</span><span class="p">:</span><span class="w"> </span><span class="s2">"merge"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"patch_from"</span><span class="p">:</span><span class="w"> </span><span class="mi">1233</span><span class="p">,</span><span class="w">
  </span><span class="c1">...</span><span class="w"> </span><span class="c1">// rest of document is an RFC 7386 payload</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li>Note that <code class="language-plaintext highlighter-rouge">patch_style</code> and <code class="language-plaintext highlighter-rouge">patch_from</code> must be removed from the document before it’s a valid RFC 7386 merge patch.</li> <li><code class="language-plaintext highlighter-rouge">patch_from</code> indicates the revision to apply the patches to</li> </ul> <p>The merge patch should be applied and the resulting document stored to history. If the referenced <code class="language-plaintext highlighter-rouge">from</code> revision is not available or history, or if patching fails, you should set intent’s <code class="language-plaintext highlighter-rouge">ack_state_rev</code> back to 0 to request a full <code class="language-plaintext highlighter-rouge">set</code> state.</p> <h1 id="older-versions"> <a href="#older-versions" class="anchor-heading" aria-labelledby="older-versions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Older versions </h1> <p>Version 1 sent the complete world-state as is, and with entities as an array rather than an object. It looked like this:</p> <div class="language-json-doc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entities</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="c1">// list of all entities; see Entities above for structure</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span><span class="na">revision</span><span class="p">:</span><span class="w"> </span><span class="mi">1234</span><span class="w"> </span><span class="c1">// monotonically increasing integer (will roll over to 0 after INT64_MAX!)</span><span class="w">
</span></code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
